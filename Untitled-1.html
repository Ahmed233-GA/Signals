<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathVision AI | Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Math.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#020617', // Slate 950
                            800: '#0f172a', // Slate 900
                            700: '#1e293b', // Slate 800
                        },
                        brand: {
                            blue: '#3b82f6',
                            glow: '#60a5fa',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #020617; 
            background-image: radial-gradient(circle at top right, #1e3a8a 0%, transparent 20%), radial-gradient(circle at bottom left, #1e1b4b 0%, transparent 20%);
            background-attachment: fixed;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .loader {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Markdown Styles for Dark Mode */
        .markdown-body { color: #e2e8f0; font-size: 0.95rem; line-height: 1.7; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #f8fafc; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; }
        .markdown-body strong { color: #60a5fa; }
        .markdown-body code { background: #1e293b; color: #93c5fd; padding: 0.2em 0.4em; rounded: 4px; font-family: monospace; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; color: #cbd5e1; }
        .markdown-body ol { list-style-type: decimal; margin-left: 1.5rem; color: #cbd5e1; }
        .markdown-body blockquote { border-left: 4px solid #3b82f6; padding-left: 1rem; color: #94a3b8; font-style: italic; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="text-slate-200 font-sans antialiased selection:bg-blue-500 selection:text-white">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-white/5 pb-6">
            <div class="mb-4 md:mb-0 text-center md:text-left">
                <h1 class="text-4xl font-extrabold tracking-tight text-white mb-1">
                    MATH<span class="text-blue-500">VISION</span>
                </h1>
                <p class="text-slate-400 text-sm font-medium tracking-wide uppercase">Professional Function Analysis</p>
            </div>
            
            <div class="flex gap-3">
                <div class="px-4 py-2 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-bold uppercase tracking-wider">
                    <i class="fas fa-circle text-[8px] mr-2 animate-pulse"></i>AI Engine Ready
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="glass-panel rounded-2xl p-1 mb-8 shadow-2xl shadow-black/50">
            <div class="bg-dark-800/50 rounded-xl p-6 md:p-8">
                <div class="flex flex-col md:flex-row gap-6 items-start">
                    
                    <!-- Text Input -->
                    <div class="flex-grow w-full">
                        <label class="block text-xs font-bold text-blue-400 uppercase tracking-wider mb-3">Function f(x)</label>
                        <div class="relative group">
                            <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl opacity-20 group-focus-within:opacity-100 transition duration-500 blur"></div>
                            <div class="relative flex">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-serif italic text-lg">f(x) =</span>
                                <input type="text" id="functionInput" 
                                    class="w-full pl-16 pr-32 py-4 bg-dark-900 border border-slate-700 rounded-xl focus:outline-none text-xl font-mono text-white placeholder-slate-600 shadow-inner transition-all"
                                    placeholder="x^2 + 2" value="cos(x) + sin(2*x)">
                                <button onclick="analyzeFunction()" 
                                    class="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-lg font-bold transition-all shadow-lg shadow-blue-900/50 flex items-center gap-2">
                                    Analyze <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Image Input -->
                    <div class="w-full md:w-auto flex-shrink-0">
                        <label class="block text-xs font-bold text-blue-400 uppercase tracking-wider mb-3 text-center md:text-left">
                            Vision Input
                        </label>
                        <div class="relative group">
                            <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="handleImageUpload()">
                            <label for="imageInput" 
                                class="flex items-center justify-center gap-3 px-8 py-4 bg-dark-900 border border-slate-700 hover:border-blue-500 rounded-xl cursor-pointer transition-all group-hover:shadow-[0_0_20px_rgba(59,130,246,0.15)]">
                                <i class="fas fa-camera text-blue-500 text-xl"></i> 
                                <span class="font-bold text-slate-300 group-hover:text-white transition-colors">Scan</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Global Loader -->
                <div id="globalLoader" class="hidden mt-6 text-center animate-fade-in">
                    <div class="inline-flex items-center gap-3 text-blue-400 font-medium bg-blue-950/30 px-5 py-2 rounded-full border border-blue-500/20">
                        <div class="loader"></div>
                        <span id="loadingText" class="tracking-wide text-sm">Processing...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area (Hidden initially) -->
        <div id="resultsArea" class="hidden space-y-8">
            
            <!-- Graph & Basic Stats Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Graph Container -->
                <div class="lg:col-span-2 glass-panel rounded-2xl p-1 shadow-xl">
                    <div class="bg-dark-800/80 rounded-xl p-4 h-full">
                        <div class="flex justify-between items-center mb-2 px-2">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider"><i class="fas fa-chart-line mr-2"></i>Visualization</h3>
                        </div>
                        <div id="plot" class="w-full h-80 md:h-[450px] rounded-lg overflow-hidden"></div>
                    </div>
                </div>

                <!-- Stats & Tools Column -->
                <div class="lg:col-span-1 flex flex-col gap-6">
                    
                    <!-- Numerical Analysis Card -->
                    <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i class="fas fa-calculator text-6xl text-white"></i>
                        </div>
                        <h3 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-6 border-b border-white/10 pb-2">Properties</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Parity</p>
                                <div class="flex items-center gap-3">
                                    <div id="parityIcon" class="w-2 h-2 rounded-full bg-slate-600"></div>
                                    <p id="parityResult" class="text-xl font-bold text-white tracking-tight">-</p>
                                </div>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Periodicity</p>
                                <div class="flex items-center gap-3">
                                    <div id="periodicIcon" class="w-2 h-2 rounded-full bg-slate-600"></div>
                                    <p id="periodicResult" class="text-xl font-bold text-white tracking-tight">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Actions Card -->
                    <div class="glass-panel rounded-2xl p-1 flex-grow">
                        <div class="bg-gradient-to-b from-blue-900/20 to-dark-900/50 rounded-xl p-6 h-full border border-blue-500/10">
                            <h3 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-6 flex items-center gap-2">
                                <i class="fas fa-microchip"></i> AI Analysis
                            </h3>
                            <div class="space-y-3">
                                <button onclick="generateAIProof()" class="group w-full py-4 px-5 bg-dark-700 hover:bg-blue-600 border border-slate-600 hover:border-blue-500 rounded-xl font-bold text-slate-300 hover:text-white text-left transition-all flex items-center justify-between shadow-lg">
                                    <span class="flex items-center gap-3"><i class="fas fa-file-signature text-blue-400 group-hover:text-white"></i> Formal Proof</span>
                                    <i class="fas fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </button>
                                <button onclick="explainGraph()" class="group w-full py-4 px-5 bg-dark-700 hover:bg-blue-600 border border-slate-600 hover:border-blue-500 rounded-xl font-bold text-slate-300 hover:text-white text-left transition-all flex items-center justify-between shadow-lg">
                                    <span class="flex items-center gap-3"><i class="fas fa-chalkboard-user text-blue-400 group-hover:text-white"></i> Graph Tutor</span>
                                    <i class="fas fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Output Section -->
            <div id="aiOutputSection" class="hidden glass-panel rounded-2xl overflow-hidden border border-blue-500/30 shadow-[0_0_40px_rgba(59,130,246,0.1)]">
                <div class="bg-dark-800/90 px-8 py-5 border-b border-white/5 flex justify-between items-center backdrop-blur-md">
                    <h3 class="text-blue-400 font-bold flex items-center gap-3 tracking-wide">
                        <i class="fas fa-robot text-lg"></i> GEMINI INTELLIGENCE
                    </h3>
                    <button onclick="document.getElementById('aiOutputSection').classList.add('hidden')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="aiContent" class="p-8 md:p-10 prose prose-invert max-w-none markdown-body bg-dark-900/50">
                    <!-- AI Content will be injected here -->
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="mt-20 text-center text-slate-600 text-xs border-t border-white/5 pt-8">
            <p>POWERED BY GEMINI 2.0 FLASH & MATH.JS</p>
        </div>

    </div>

    <!-- API Key Warning Modal -->
    <dialog id="keyModal" class="p-0 rounded-2xl shadow-2xl backdrop:bg-black/80 bg-transparent open:animate-fade-in">
        <div class="glass-panel p-1 rounded-2xl max-w-sm w-full m-auto">
            <div class="bg-dark-900 rounded-xl p-6 border border-slate-700">
                <div class="text-center mb-6">
                    <div class="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500">
                        <i class="fas fa-key"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">Authentication Required</h3>
                    <p class="text-sm text-slate-400">Please enter your Google Gemini API Key to access AI features.</p>
                </div>
                
                <input type="password" id="userApiKey" placeholder="sk-..." class="w-full p-3 bg-black border border-slate-700 rounded-lg text-white mb-6 focus:border-blue-500 outline-none text-sm font-mono">
                
                <div class="flex gap-3">
                    <button onclick="document.getElementById('keyModal').close()" class="flex-1 py-2.5 text-slate-400 hover:text-white font-medium text-sm transition-colors">Cancel</button>
                    <button onclick="saveKey()" class="flex-1 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm shadow-lg shadow-blue-900/50 transition-all">Save Key</button>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        // --- CONFIGURATION ---
        // The execution environment will provide the key. 
        // If running locally, you can paste your key below or use the UI prompt.
        const apiKey = ""; 
        let currentApiKey = apiKey;

        // --- CORE ANALYSIS & GRAPHING ---

        function analyzeFunction() {
            const exprStr = document.getElementById('functionInput').value;
            if (!exprStr.trim()) return;

            // Show UI with animation
            const results = document.getElementById('resultsArea');
            results.classList.remove('hidden');
            results.classList.add('animate-fade-in-up');
            
            document.getElementById('aiOutputSection').classList.add('hidden'); // Hide old AI results

            // Graphing
            try {
                plotGraph(exprStr);
                numericalCheck(exprStr);
            } catch (err) {
                alert("Could not parse function. Please use standard math notation (e.g., x^2, sin(x)).");
            }
        }

        function plotGraph(exprStr) {
            const parser = math.parser();
            const compiled = math.compile(exprStr);

            const xValues = [];
            const yValues = [];
            const range = 10;
            const step = 0.1;

            for (let x = -range; x <= range; x += step) {
                try {
                    let y = compiled.evaluate({x: x});
                    if (typeof y === 'object' && 're' in y) y = y.re; 
                    if (!isFinite(y) || isNaN(y)) y = null;
                    xValues.push(x);
                    yValues.push(y);
                } catch(e) { }
            }

            const trace = {
                x: xValues,
                y: yValues,
                mode: 'lines',
                type: 'scatter',
                line: {shape: 'spline', color: '#60a5fa', width: 4}, // Blue-400
                name: 'f(x)',
                fill: 'tozeroy',
                fillcolor: 'rgba(59, 130, 246, 0.1)'
            };

            // Dark Mode Plotly Layout
            const layout = {
                title: { 
                    text: `f(x) = ${exprStr}`, 
                    font: { size: 16, color: '#94a3b8', family: 'monospace' } 
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#cbd5e1' },
                xaxis: {
                    title: 'x', 
                    zeroline: true, 
                    zerolinecolor: '#475569', 
                    gridcolor: '#1e293b',
                    tickcolor: '#cbd5e1'
                },
                yaxis: {
                    title: 'y', 
                    zeroline: true, 
                    zerolinecolor: '#475569', 
                    gridcolor: '#1e293b',
                    tickcolor: '#cbd5e1'
                },
                margin: {t: 40, r: 20, b: 40, l: 50},
                hovermode: 'closest',
                showlegend: false
            };
            
            const config = {
                displayModeBar: false, 
                responsive: true
            };

            Plotly.newPlot('plot', [trace], layout, config);
        }

        function numericalCheck(exprStr) {
            const compiled = math.compile(exprStr);
            const tolerance = 0.001;
            let isEven = true, isOdd = true;
            
            [1.5, 2.2, 3.7].forEach(val => {
                try {
                    const fx = compiled.evaluate({x: val});
                    const fneg = compiled.evaluate({x: -val});
                    if (Math.abs(fx - fneg) > tolerance) isEven = false;
                    if (Math.abs(fx + fneg) > tolerance) isOdd = false;
                } catch(e) { isEven=false; isOdd=false; }
            });

            const parityEl = document.getElementById('parityResult');
            const parityIcon = document.getElementById('parityIcon');
            
            if(isEven) { 
                parityEl.textContent = "Even Function"; 
                parityEl.className = "text-xl font-bold text-emerald-400 tracking-tight"; 
                parityIcon.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]";
            }
            else if(isOdd) { 
                parityEl.textContent = "Odd Function"; 
                parityEl.className = "text-xl font-bold text-purple-400 tracking-tight"; 
                parityIcon.className = "w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_10px_#a855f7]";
            }
            else { 
                parityEl.textContent = "Neither"; 
                parityEl.className = "text-xl font-bold text-slate-500 tracking-tight"; 
                parityIcon.className = "w-2 h-2 rounded-full bg-slate-600";
            }

            const periodicEl = document.getElementById('periodicResult');
            const periodicIcon = document.getElementById('periodicIcon');
            const lower = exprStr.toLowerCase();
            
            if(lower.includes('sin') || lower.includes('cos') || lower.includes('tan')) {
                periodicEl.textContent = "Likely Periodic";
                periodicEl.className = "text-xl font-bold text-blue-400 tracking-tight";
                periodicIcon.className = "w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]";
            } else {
                periodicEl.textContent = "Non-Periodic";
                periodicEl.className = "text-xl font-bold text-slate-500 tracking-tight";
                periodicIcon.className = "w-2 h-2 rounded-full bg-slate-600";
            }
        }

        // --- GEMINI AI INTEGRATION ---

        async function callGemini(prompt, imageData = null) {
            if (!currentApiKey) {
                document.getElementById('keyModal').showModal();
                throw new Error("No API Key");
            }

            const model = imageData ? "gemini-2.5-flash-preview-09-2025" : "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentApiKey}`;

            const parts = [{ text: prompt }];
            if (imageData) {
                const base64Clean = imageData.split(',')[1] || imageData;
                parts.push({
                    inlineData: {
                        mimeType: "image/png",
                        data: base64Clean
                    }
                });
            }

            const payload = { contents: [{ parts: parts }] };

            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "API Error");
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function handleImageUpload() {
            const input = document.getElementById('imageInput');
            if (input.files && input.files[0]) {
                toggleLoader(true, "Scanning Vision...");
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Img = e.target.result;
                    try {
                        const prompt = "Look at this image. Extract the mathematical function shown. Return ONLY the raw function expression that can be parsed by a calculator (e.g. 'x^2 + 2x', 'sin(x)'). Do not include 'f(x)=' or any markdown.";
                        let text = await callGemini(prompt, base64Img);
                        
                        text = text.replace(/`/g, '').replace('f(x)=', '').replace('f(x) =', '').trim();
                        
                        document.getElementById('functionInput').value = text;
                        analyzeFunction();
                    } catch (err) {
                        console.error(err);
                        alert("AI Scan failed. Please check your API key.");
                    } finally {
                        toggleLoader(false);
                        input.value = ''; 
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function generateAIProof() {
            const func = document.getElementById('functionInput').value;
            if(!func) return;

            toggleLoader(true, "Deriving Proof...");
            const aiSection = document.getElementById('aiOutputSection');
            const aiContent = document.getElementById('aiContent');

            try {
                const prompt = `Analyze the function f(x) = ${func}. 
                1. Determine if it is Even, Odd, or Neither. Provide a step-by-step rigorous mathematical proof (show f(-x)).
                2. Determine if it is Periodic. Prove it.
                3. Use clean Markdown formatting. Use bold for headers. Wrap LaTeX math in single $ signs.`;
                
                const result = await callGemini(prompt);
                
                aiSection.classList.remove('hidden');
                aiContent.innerHTML = marked.parse(result);
                aiSection.scrollIntoView({behavior: 'smooth'});
            } catch (err) {
                alert("Failed to generate proof: " + err.message);
            } finally {
                toggleLoader(false);
            }
        }

        async function explainGraph() {
            const func = document.getElementById('functionInput').value;
            if(!func) return;

            toggleLoader(true, "Analyzing Graph...");
            const aiSection = document.getElementById('aiOutputSection');
            const aiContent = document.getElementById('aiContent');

            try {
                const prompt = `Act as a math tutor. Explain the graph of f(x) = ${func}.
                Cover: Domain, Range, Intercepts, Asymptotes, and End Behavior. 
                Keep it concise and clear.`;
                
                const result = await callGemini(prompt);
                
                aiSection.classList.remove('hidden');
                aiContent.innerHTML = marked.parse(result);
                aiSection.scrollIntoView({behavior: 'smooth'});
            } catch (err) {
                alert("Failed to explain graph: " + err.message);
            } finally {
                toggleLoader(false);
            }
        }

        function toggleLoader(show, text = "Processing...") {
            const loader = document.getElementById('globalLoader');
            const txt = document.getElementById('loadingText');
            if(show) {
                loader.classList.remove('hidden');
                txt.textContent = text;
            } else {
                loader.classList.add('hidden');
            }
        }

        function saveKey() {
            const key = document.getElementById('userApiKey').value;
            if(key) {
                currentApiKey = key;
                document.getElementById('keyModal').close();
                // Simple visual feedback
                const btn = document.querySelector('button[onclick="saveKey()"]');
                const originalText = btn.textContent;
                btn.textContent = "Saved!";
                setTimeout(() => btn.textContent = originalText, 2000);
            }
        }
    </script>
</body>
</html>